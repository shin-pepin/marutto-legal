{% comment %}
  最終確認画面ブロック - 2022年改正特商法 第12条の6 対応
  カートページに法定6項目を表示するTheme App Extension

  Metafield namespace: $app:confirmation → Liquid: app.metafields.confirmation.<key>
{% endcomment %}

{% assign enabled = app.metafields.confirmation.enabled.value %}

{% if enabled == true %}
  <div class="marutto-confirmation" style="
    border: 2px solid #d4a017;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    background-color: #fffef5;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    color: #333;
  ">
    <h3 style="
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 700;
      color: #333;
      border-bottom: 1px solid #e5e5e5;
      padding-bottom: 12px;
    ">
      {{ section.settings.title }}
    </h3>

    {% assign quantity_text = app.metafields.confirmation.quantity_text.value %}
    {% if quantity_text != blank %}
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #666;">
          {{ 'confirmation.quantity_label' | t }}
        </p>
        <p style="margin: 0;">{{ quantity_text }}</p>
      </div>
    {% endif %}

    {% assign price_text = app.metafields.confirmation.price_text.value %}
    {% if price_text != blank %}
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #666;">
          {{ 'confirmation.price_label' | t }}
        </p>
        <p style="margin: 0;">{{ price_text }}</p>
      </div>
    {% endif %}

    {% assign payment_text = app.metafields.confirmation.payment_text.value %}
    {% if payment_text != blank %}
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #666;">
          {{ 'confirmation.payment_label' | t }}
        </p>
        <p style="margin: 0;">{{ payment_text }}</p>
      </div>
    {% endif %}

    {% assign delivery_text = app.metafields.confirmation.delivery_text.value %}
    {% if delivery_text != blank %}
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #666;">
          {{ 'confirmation.delivery_label' | t }}
        </p>
        <p style="margin: 0;">{{ delivery_text }}</p>
      </div>
    {% endif %}

    {% assign cancellation_text = app.metafields.confirmation.cancellation_text.value %}
    {% if cancellation_text != blank %}
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #666;">
          {{ 'confirmation.cancellation_label' | t }}
        </p>
        <p style="margin: 0;">{{ cancellation_text }}</p>
      </div>
    {% endif %}

    {% assign period_text = app.metafields.confirmation.period_text.value %}
    {% if period_text != blank %}
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #666;">
          {{ 'confirmation.period_label' | t }}
        </p>
        <p style="margin: 0;">{{ period_text }}</p>
      </div>
    {% endif %}

    {% if section.settings.show_checkbox %}
      {% assign checkbox_label = app.metafields.confirmation.checkbox_label.value %}
      {% if checkbox_label != blank %}
        <div style="
          margin-top: 16px;
          padding-top: 12px;
          border-top: 1px solid #e5e5e5;
        ">
          <label style="
            display: flex;
            align-items: flex-start;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
          ">
            <input
              type="checkbox"
              id="marutto-confirmation-checkbox"
              style="margin-top: 3px; width: 16px; height: 16px;"
            >
            <span>{{ checkbox_label }}</span>
          </label>
          <p id="marutto-confirmation-warning" style="
            margin: 8px 0 0 0;
            font-size: 12px;
            color: #c00;
            display: none;
          ">
            {{ 'confirmation.checkbox_required' | t }}
          </p>
        </div>

        <script>
          (function() {
            var checkbox = document.getElementById('marutto-confirmation-checkbox');
            var warning = document.getElementById('marutto-confirmation-warning');
            if (!checkbox) return;

            /* Selectors for common checkout/submit buttons on the cart page */
            var BTN_SELECTORS = [
              '[name="checkout"]',
              'button[type="submit"][name="checkout"]',
              'input[type="submit"][name="checkout"]',
              '.shopify-payment-button button',
              '.cart__checkout-button',
              '[data-shopify="payment-button"] button'
            ].join(',');

            function getButtons() {
              return document.querySelectorAll(BTN_SELECTORS);
            }

            function toggle() {
              var checked = checkbox.checked;
              var buttons = getButtons();
              for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = !checked;
                buttons[i].style.opacity = checked ? '' : '0.5';
                buttons[i].style.pointerEvents = checked ? '' : 'none';
              }
              warning.style.display = checked ? 'none' : 'block';
            }

            checkbox.addEventListener('change', toggle);

            /* Initial state: buttons disabled until checked */
            toggle();

            /* Re-apply after DOM changes (dynamic cart updates) */
            var observer = new MutationObserver(function() { toggle(); });
            var cart = document.querySelector('form[action="/cart"]') || document.body;
            observer.observe(cart, { childList: true, subtree: true });
          })();
        </script>
      {% endif %}
    {% endif %}
  </div>
{% endif %}

{% schema %}
{
  "name": "最終確認画面",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "タイトル",
      "default": "ご注文に関する重要事項"
    },
    {
      "type": "checkbox",
      "id": "show_checkbox",
      "label": "確認チェックボックスを表示",
      "default": true
    }
  ]
}
{% endschema %}
