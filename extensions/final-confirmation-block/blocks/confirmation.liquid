{% comment %}
  最終確認画面ブロック - 2022年改正特商法 第12条の6 対応
  カートページに法定6項目を表示するTheme App Extension

  Metafield namespace: marutto_confirmation
  Liquid: shop.metafields["marutto_confirmation"]["<key>"]
{% endcomment %}

{% assign ns = shop.metafields["marutto_confirmation"] %}
{% assign enabled = ns["enabled"].value %}

{% if enabled == true %}
  {% assign block_title = section.settings.title | default: "ご注文に関する重要事項" %}

  <style>
    .marutto-confirmation {
      margin: 24px 0;
      font-size: 14px;
      line-height: 1.7;
      color: inherit;
      font-family: inherit;
    }
    .marutto-confirmation details {
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 4px;
    }
    .marutto-confirmation summary {
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      list-style: revert;
    }
    .marutto-confirmation summary::-webkit-details-marker {
      color: inherit;
    }
    .marutto-confirmation__items {
      padding: 0 16px 16px;
    }
    .marutto-confirmation__item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 10px;
    }
    .marutto-confirmation__item:last-child {
      border-bottom: none;
    }
    .marutto-confirmation__label {
      display: block;
      font-weight: bold;
      font-size: 11px;
      color: rgba(0, 0, 0, 0.5);
      margin-bottom: 2px;
    }
    .marutto-confirmation__value {
      margin: 0;
      word-break: break-word;
    }
    .marutto-confirmation__checkbox-area {
      margin-top: 12px;
    }
    .marutto-confirmation__checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }
    .marutto-confirmation__checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: currentColor;
      cursor: pointer;
      flex-shrink: 0;
    }
    .marutto-confirmation__warning {
      margin: 8px 0 0 28px;
      font-size: 12px;
      color: #b00;
      display: none;
    }
  </style>

  <div class="marutto-confirmation">
    <details>
      <summary>{{ block_title }}</summary>
      <div class="marutto-confirmation__items">
        {% assign quantity_text = ns["quantity_text"].value %}
        {% if quantity_text != blank %}
          <div class="marutto-confirmation__item">
            <span class="marutto-confirmation__label">{{ 'confirmation.quantity_label' | t }}</span>
            <p class="marutto-confirmation__value">{{ quantity_text }}</p>
          </div>
        {% endif %}

        {% assign price_text = ns["price_text"].value %}
        {% if price_text != blank %}
          <div class="marutto-confirmation__item">
            <span class="marutto-confirmation__label">{{ 'confirmation.price_label' | t }}</span>
            <p class="marutto-confirmation__value">{{ price_text }}</p>
          </div>
        {% endif %}

        {% assign payment_text = ns["payment_text"].value %}
        {% if payment_text != blank %}
          <div class="marutto-confirmation__item">
            <span class="marutto-confirmation__label">{{ 'confirmation.payment_label' | t }}</span>
            <p class="marutto-confirmation__value">{{ payment_text }}</p>
          </div>
        {% endif %}

        {% assign delivery_text = ns["delivery_text"].value %}
        {% if delivery_text != blank %}
          <div class="marutto-confirmation__item">
            <span class="marutto-confirmation__label">{{ 'confirmation.delivery_label' | t }}</span>
            <p class="marutto-confirmation__value">{{ delivery_text }}</p>
          </div>
        {% endif %}

        {% assign cancellation_text = ns["cancellation_text"].value %}
        {% if cancellation_text != blank %}
          <div class="marutto-confirmation__item">
            <span class="marutto-confirmation__label">{{ 'confirmation.cancellation_label' | t }}</span>
            <p class="marutto-confirmation__value">{{ cancellation_text }}</p>
          </div>
        {% endif %}

        {% assign period_text = ns["period_text"].value %}
        {% if period_text != blank %}
          <div class="marutto-confirmation__item">
            <span class="marutto-confirmation__label">{{ 'confirmation.period_label' | t }}</span>
            <p class="marutto-confirmation__value">{{ period_text }}</p>
          </div>
        {% endif %}
      </div>
    </details>

    {% assign checkbox_label = ns["checkbox_label"].value %}
    {% if checkbox_label == blank %}
      {% assign checkbox_label = "上記の内容を確認しました" %}
    {% endif %}

    <div class="marutto-confirmation__checkbox-area">
      <label class="marutto-confirmation__checkbox-label">
        <input
          type="checkbox"
          id="marutto-confirmation-checkbox"
        >
        <span>{{ checkbox_label }}</span>
      </label>
      <p class="marutto-confirmation__warning" id="marutto-confirmation-warning">
        {{ 'confirmation.checkbox_required' | t }}
      </p>
    </div>

    <script>
      (function() {
        var checkbox = document.getElementById('marutto-confirmation-checkbox');
        var warning = document.getElementById('marutto-confirmation-warning');
        if (!checkbox) return;

        var BTN_SELECTORS = [
          '[name="checkout"]',
          'button[type="submit"][name="checkout"]',
          'input[type="submit"][name="checkout"]',
          '.shopify-payment-button button',
          '.cart__checkout-button',
          '[data-shopify="payment-button"] button'
        ].join(',');

        function getButtons() {
          return document.querySelectorAll(BTN_SELECTORS);
        }

        function toggle() {
          var checked = checkbox.checked;
          var buttons = getButtons();
          for (var i = 0; i < buttons.length; i++) {
            buttons[i].disabled = !checked;
            buttons[i].style.opacity = checked ? '' : '0.5';
            buttons[i].style.pointerEvents = checked ? '' : 'none';
          }
          warning.style.display = checked ? 'none' : 'block';
        }

        checkbox.addEventListener('change', toggle);
        toggle();

        var observer = new MutationObserver(function() { toggle(); });
        var cart = document.querySelector('form[action="/cart"]') || document.body;
        observer.observe(cart, { childList: true, subtree: true });
      })();
    </script>
  </div>
{% endif %}

{% schema %}
{
  "name": "最終確認画面",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "タイトル",
      "default": "ご注文に関する重要事項"
    },
    {
      "type": "checkbox",
      "id": "show_checkbox",
      "label": "確認チェックボックスを表示",
      "default": true
    }
  ]
}
{% endschema %}
